<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HKG81 QM Dashboard</title>
    <link rel="stylesheet" media="screen" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="bootstrap-datepicker3.min.css"/>
    
    <script src="http://code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" type="text/javascript"></script>
    <!--<script src="https://api.trello.com/1/client.js?key=8a42b4468e08ca9f165c88d1327add61"></script>-->
    <script src="bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="button-checkbox.js" type="text/javascript"></script>
    <script src="main.js" type="text/javascript"></script>
    
    <script type="text/javascript">
        var cards = [];
        
        var loadedListCount = 0;
        var addLabelSuccCount = 0;
        var addLabelErrCount = 0;
        var addChklstItemSuccCount = 0;
        var addChklstItemErrCount = 0;
        
        var loadLists = function() {
            for (var i = 0; i < listIds.length; i++) {
                trelloGet('/lists/'+listIds[i]+'/cards', 
                    concatLists, 
                    function() { failAlert("load list "+listIds[i]+" fail"); }
                );
            }
        };
        
        var concatLists = function(lists) {
            cards = cards.concat(lists);
            
            loadedListCount++;
            if (loadedListCount == listIds.length) {
                createItemCheckboxes();
                
                $('#loader').hide();
                $('.items').removeClass('hidden');
            }
        };
        
        var createItemCheckboxes = function() {
            cards.sort( function(a, b) {
                return a.name.localeCompare(b.name);
            });
            
            $.each(cards, function(index, card) {
                var checkbox = '<div class="button-checkbox col-xs-6 col-sm-4 col-md-3" style="padding-bottom: 5px;">';
                
                // have Damaged Label
                if (hasLabel(card, damagedLabelId)) {
                    checkbox += '<button type="button" class="btn" data-color="success">'+card.name+'&nbsp;<span style="border-right: 5px #c9302c solid;">&nbsp;</span></button>';
                // have Broken Label
                } else if (hasLabel(card, brokenLabelId)) {
                    checkbox += '<button type="button" class="btn" data-color="success" disabled>'+card.name+'&nbsp;<span style="border-right: 5px black solid;">&nbsp;</span></button>';
                } else {
                    checkbox += '<button type="button" class="btn" data-color="success">'+card.name+'</button>';
                }
                
                checkbox += '<input type="checkbox" name="items" value="'+card.url+'" class="hidden" /></div>';
                
                if (hasLabel(card, tentLabelId)) {
                    $('#tent-items').append(checkbox);
                } else if (hasLabel(card, yurtLabelId)) {
                    $('#yurt-items').append(checkbox);
                } else if (hasLabel(card, tentpegLabelId)) {
                    $('#tentpeg-items').append(checkbox);
                } else if (hasLabel(card, flyLabelId)) {
                    $('#fly-items').append(checkbox);
                } else if (hasLabel(card, cooksetLabelId)) {
                    $('#cookset-items').append(checkbox);
                } else if (hasLabel(card, stoveLabelId)) {
                    $('#stove-items').append(checkbox);
                } else {
                    $('#other-items').append(checkbox);
                }
            });
            button_checkbox_init();
        }
        
        var addCard = function() {
            var itemUrls = "";
            $('input:checked[name=items]').each(function(index){
                itemUrls += $(this).val() + "\n";
            });
            
            var newCard = {
                name: "BF [" + $("#borrow_dt").val() + "]",
                desc: "Borrow Date: " + $("#borrow_dt").val() + "\n" +
                      "Applicant: " + $("#applicant").val() + "\n" +
                      "Return Date: " + $("#return_dt").val() + "\n" +
                      "\n\n-------\n" + itemUrls,
                idList: pendingListId,
                due: null
            };
            
            trelloPost('/cards', 
                newCard, 
                addLabelAndChecklist, 
                function() { failAlert("Add Card Failed"); }
            );
            
        }
        
        var addLabelAndChecklist = function(card) {
            trelloPost('/cards/'+card.id+'/idLabels', 
                { value: borrowLabelId }, 
                function() { addLabelSuccCount++; addCardFinishing(); },
                function() { addLabelErrCount++; addCardFinishing(); }
            );
            
            trelloPost('/cards/'+card.id+'/checklists', 
                { name: 'Return Checklist' }, 
                addChecklistItems,
                function() { failAlert("Add Checklist Failed"); }
            );
        }
        
        var addChecklistItems = function(checklist) {
            $('input:checked[name=items]').each(function(index){
                trelloPost('/checklists/'+checklist.id+'/checkItems', 
                    { name: $(this).val() }, 
                    function() { addChklstItemSuccCount++; addCardFinishing(); },
                    function() { addChklstItemErrCount++; addCardFinishing(); }
                );
            });
        }
        
        var addCardFinishing = function() {
            var total = $('input:checked[name=items]').length + 1;
            if (addLabelSuccCount + addLabelErrCount + addChklstItemSuccCount + addChklstItemErrCount >= total) {
                if (addLabelErrCount > 0 || addChklstItemErrCount > 0) {
                    failAlert("Add Card Failed");
                } else {
                    successAlert("Add Card Successfully");
                }
            }
        }
        
        $(function(){
            $("#submit").on("click", addCard);
            
            loadLists();
            /*
            Trello.authorize({
                type: "popup",
                name: "HKG81 QM",
                scope: {
                    read: true,
                    write: true },
                expiration: "never",
                success: loadLists,
                error: function() { failAlert("Failed authentication"); }
            });
            */
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>HKG81 QM</h1>
      
        <div class="hidden alert alert-dismissible" role="alert" id="alert-box">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <span id="alert-msg"></span>
        </div>
        
        <form name="form" class="form-horizontal">
            <div id="item_info" class="panel panel-default">
                <div class="panel-body">
                    <div class="form-group">
                        <label class="control-label col-xs-4 col-sm-2">支部</label>
                        <div class="col-xs-4 col-sm-2">
                            <label class="radio-inline ">
                                <input type="radio" name="branch" value="scout"> 童軍
                            </label>
                        </div>
                        <div class="col-xs-4 col-sm-2">
                            <label class="radio-inline ">
                                <input type="radio" name="branch" value="venture"> 深資童軍
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrower" class="control-label col-xs-4 col-sm-2">申請人</label>
                        <div class="col-xs-8 col-sm-10">
                            <input type="text" name="applicant" id="applicant" class="form-control" value=""/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrower" class="control-label col-xs-4 col-sm-2">職位</label>
                        <div class="col-xs-8 col-sm-10">
                            <input type="text" name="post" id="post" class="form-control" value=""/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrower" class="control-label col-xs-4 col-sm-2">E-mail</label>
                        <div class="col-xs-8 col-sm-10">
                            <input type="text" name="email" id="email" class="form-control" value=""/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="activity" class="control-label col-xs-4 col-sm-2">活動</label>
                        <div class="col-xs-8 col-sm-10">
                            <input type="text" name="activity" id="activity" class="form-control" value=""/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrow_dt" class="control-label col-xs-4 col-sm-2">借用日期</label>
                        <div class="col-xs-8 col-sm-10">
                            <input type="text" name="borrow_dt" id="borrow_dt" class="form-control datepicker" placeholder="yyyy/mm/dd" value=""/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="return_dt" class="control-label col-xs-4 col-sm-2">歸還日期</label>
                        <div class="col-xs-8 col-sm-10">
                            <input type="text" name="return_dt" id="return_dt" class="form-control datepicker" placeholder="yyyy/mm/dd" value=""/>
                        </div>
                    </div>
                    <div class="form-group" id="loader">
                        <div class="col-xs-12 col-sm-12" style="text-align:center;">
                            <img src="loading.gif"/>
                        </div>
                    </div>
                    <div class="form-group hidden items">
                        <div class="col-xs-12" style="text-align:right; font-size: 10px; color: #666666;">
                            <span style="border-right: 5px #c9302c solid;">&nbsp;</span>&nbsp;&nbsp;損壞
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <span style="border-right: 5px #000000 solid;">&nbsp;</span>&nbsp;&nbsp;不能使用
                        </div>
                    </div>
                    <div class="form-group hidden items">
                        <label class="control-label col-xs-12 col-sm-2" style="padding-bottom: 5px;">A字營</label>
                        <div id="tent-items" class="col-xs-12 col-sm-10" style="padding-left: 0px; padding-right: 0px;"></div>
                    </div>
                    <div class="form-group hidden items">
                        <label class="control-label col-xs-12 col-sm-2" style="padding-bottom: 5px;">蒙古包</label>
                        <div id="yurt-items" class="col-xs-12 col-sm-10" style="padding-left: 0px; padding-right: 0px;"></div>
                    </div>
                    <div class="form-group hidden items">
                        <label class="control-label col-xs-12 col-sm-2" style="padding-bottom: 5px;">營釘</label>
                        <div id="tentpeg-items" class="col-xs-12 col-sm-10" style="padding-left: 0px; padding-right: 0px;"></div>
                    </div>
                    <div class="form-group hidden items">
                        <label class="control-label col-xs-12 col-sm-2" style="padding-bottom: 5px;">天幕</label>
                        <div id="fly-items" class="col-xs-12 col-sm-10" style="padding-left: 0px; padding-right: 0px;"></div>
                    </div>
                    <div class="form-group hidden items">
                        <label class="control-label col-xs-12 col-sm-2" style="padding-bottom: 5px;">炊具</label>
                        <div id="cookset-items" class="col-xs-12 col-sm-10" style="padding-left: 0px; padding-right: 0px;"></div>
                    </div>
                    <div class="form-group hidden items">
                        <label class="control-label col-xs-12 col-sm-2" style="padding-bottom: 5px;">爐頭</label>
                        <div id="stove-items" class="col-xs-12 col-sm-10" style="padding-left: 0px; padding-right: 0px;"></div>
                    </div>
                    <div class="form-group hidden items">
                        <label class="control-label col-xs-12 col-sm-2" style="padding-bottom: 5px;">其他</label>
                        <div id="other-items" class="col-xs-12 col-sm-10" style="padding-left: 0px; padding-right: 0px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="remarks" class="control-label col-xs-12 col-sm-2" style="padding-bottom: 5px;">備註</label>
                        <div class="col-xs-12 col-sm-10">
                            <textarea class="form-control" name="remarks" id="remarks" rows="3" style="resize: vertical;" placeholder="如需要其他物資，請在此填上．"></textarea>
                        </div>
                    </div>
                </div>
                <div class="panel-footer">
                    <div class="form-group">
                        <div class="col-xs-12 col-sm-12">
                            <button type="button" class="btn btn-default" id="submit">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div> 
</body>
</html>
