<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HKG81 QM Dashboard</title>
    <link rel="stylesheet" media="screen" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker3.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>

    <script src="http://code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" type="text/javascript"></script>
    <!--<script src="https://api.trello.com/1/client.js?key=8a42b4468e08ca9f165c88d1327add61"></script>-->
    <script src="js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="js/Autolinker.min.js" type="text/javascript"></script>
    <script src="js/main.js" type="text/javascript"></script>

    <script type="text/javascript">
        var cards = [];
        var loadCards = function() {
            trelloGet('/boards/'+Board+'/cards?checklists=all',
                showCards,
                function() { failAlert("load cards fail"); }
            );
        };

        var showCards = function(data) {
            $('#loader').remove();
            $('#dashboard').removeClass('hidden');

            cards = data;
            
            var borrowed_count = 0;
            var overdue_count = 0;
            var repair_count = 0;
            var drying_count = 0;
            var damaged_count = 0;
            var broken_count = 0;
            
            
            // Find out overdue items
            var OverdueCardUrls = [];
            $.each(cards, function(index, card) {
                var dueDt = null;
                if (card.due != null)
                    dueDt = new Date(card.due.substring(0,4), card.due.substring(5,7)-1, card.due.substring(8,10));

                if ( (hasLabel(card, Label.borrowRec) || hasLabel(card, Label.repairRec)) &&
                        card.idList != List.pending && card.idList != List.completed &&
                        dueDt != null && dueDt < new Date() &&
                        card.badges.checkItemsChecked < card.badges.checkItems
                        ) {
                    if (card.checklists.length > 0) {
                        for (var i = 0; i < card.checklists[0].checkItems.length; i++) {
                            if (card.checklists[0].checkItems[i].state == 'incomplete') {
                                OverdueCardUrls.push(card.checklists[0].checkItems[i].name);
                            }
                        }
                    }
                }
            });
            
            // Loop each cards
            $.each(cards, function(index, card) {
                if (!hasLabel(card, Label.borrowRec) && !hasLabel(card, Label.repairRec)) {
                    // Check card status
                    var borrowed = isBorrowed(card);
                    var overdue = ($.inArray(card.url, OverdueCardUrls) > -1);
                    var repair = (card.idList == List.repair);
                    var drying = (card.idList == List.drying);
                    var damaged = hasLabel(card, Label.damaged);
                    var broken = hasLabel(card, Label.broken);
                    
                    if (borrowed)
                        borrowed_count++;
                    if (overdue)
                        overdue_count++;
                    if (repair)
                        repair_count++;
                    if (drying)
                        drying_count++;
                    if (damaged)
                        damaged_count++;
                    if (broken)
                        broken_count++;
                }
            });
            
            $('#borrowed').html(borrowed_count);
            $('#overdue').html(overdue_count);
            $('#repair').html(repair_count);
            $('#drying').html(drying_count);
            $('#damaged').html(damaged_count);
            $('#broken').html(broken_count);
        }

        $(function(){
            //loadCards();
            $('#loader').remove();
            $('.dashboard').removeClass('hidden');
            $('#borrowed').html("8");
            $('#overdue').html("7");
            $('#repair').html("0");
            $('#drying').html("2");
            //$('#damaged').html("7");
            //$('#broken').html("1");
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">HKG81 QM</a>
            </div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="index.html">首頁</a></li>
                <li><a href="request.html">借用申請</a></li>
                <li><a href="list.html">物資清單</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">

        <div class="alert hidden" role="alert" id="alert-box">
            <span id="alert-msg"></span>
        </div>

        <div id="loader" style="text-align:center;">
            <img src="img/loading.gif"/>
        </div>
        <div class="dashboard row hidden">
            <div class="col-xs-12 col-sm-8 col-md-6">
                <div class="dashboard-item" style="background-color: #d9edf7; color: #333;">
                    <div class="dashboard-item-icon">
                        <div>
                            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                        </div>
                        <div class="dashboard-item-title">
                            借用申請情況
                        </div>
                    </div>
                    <!--
                    <div class="pull-right" style="font-size: 14px; font-weight: 200;">
                        <div>pending: </div>
                        <div>processing: </div>
                        <div>overdue: </div>
                    </div>
                    -->
                    <div class="dashboard-item-icon pull-right" style="padding-left: 30px; padding-right: 30px;">
                        <div>
                            1
                        </div>
                        <div class="dashboard-item-title">
                            pending
                        </div>
                    </div>
                    <div class="dashboard-item-icon pull-right" style="padding-left: 30px; padding-right: 30px;">
                        <div>
                            2
                        </div>
                        <div class="dashboard-item-title">
                            processing
                        </div>
                    </div>
                    <div class="dashboard-item-icon pull-right" style="padding-left: 30px; padding-right: 30px;">
                        <div>
                            3
                        </div>
                        <div class="dashboard-item-title">
                            overdue
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-item item-lbl-borrowed">
                    <div class="dashboard-item-icon">
                        <div>
                            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
                        </div>
                        <div class="dashboard-item-title">
                            借出
                        </div>
                    </div>
                    <span id="borrowed" class="dashboard-item-counter pull-right"></span>
                </div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-item item-lbl-late">
                    <div class="dashboard-item-icon">
                        <div>
                            <span class="glyphicon glyphicon-time" aria-hidden="true"></span>
                        </div>
                        <div class="dashboard-item-title">
                            逾時未還
                        </div>
                    </div>
                    <span id="overdue" class="dashboard-item-counter pull-right"></span>
                </div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-item item-lbl-repair">
                    <div class="dashboard-item-icon">
                        <div>
                            <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
                        </div>   
                        <div class="dashboard-item-title">
                            維修中
                        </div>
                    </div>
                    <span id="repair" class="dashboard-item-counter pull-right"></span>
                </div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-item item-lbl-drying">
                    <div class="dashboard-item-icon">
                        <div>
                            <span class="glyphicon glyphicon-tint" aria-hidden="true"></span>
                        </div>
                        <div class="dashboard-item-title">
                            晾曬中
                        </div>
                    </div>
                    <span id="drying" class="dashboard-item-counter pull-right"></span>
                </div>
            </div>
            <!--
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-item item-lbl-damaged">
                    <div class="dashboard-item-body">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        <span id="damaged" class="dashboard-item-counter pull-right"></span>
                    </div>
                    <div class="dashboard-item-footer">
                        損壞
                    </div>
                </div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-item item-lbl-broken">
                    <div class="dashboard-item-body">
                        <span class="glyphicon glyphicon-ban-circle" aria-hidden="true"></span>
                        <span id="broken" class="dashboard-item-counter pull-right"></span>
                    </div>
                    <div class="dashboard-item-footer">
                        不能使用
                    </div>
                </div>
            </div>
            -->
            
        </div>
        <div class="dashboard row hidden">
            
        </div>
        <div style="height: 100px">&nbsp;</div>
    </div>

</body>
</html>
