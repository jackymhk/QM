<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HKG81 QM Dashboard</title>
    <link rel="stylesheet" media="screen" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker3.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>

    <script src="http://code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" type="text/javascript"></script>
    <!--<script src="https://api.trello.com/1/client.js?key=8a42b4468e08ca9f165c88d1327add61"></script>-->
    <script src="js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="js/Autolinker.min.js" type="text/javascript"></script>
    <script src="js/main.js" type="text/javascript"></script>

    <script type="text/javascript">
        var cards = [];
        var loadCards = function() {
            trelloGet('/boards/'+Board+'/cards?attachments=cover&checklists=all',
                showCards,
                function() { failAlert("load cards fail"); }
            );
        };

        var showCards = function(data) {
            $('#loader').remove();
            $('.items').removeClass('hidden');

            cards = data;
            cards.sort( function(a, b) {
                /*
                var a_seq = getItemLabelSeq(a);
                var b_seq = getItemLabelSeq(b);
                if (a_seq != b_seq) {
                    return (a_seq > b_seq ? 1 : -1);
                } else {
                */
                    return a.name.localeCompare(b.name);
                //}
            });
            
            // Find out late items
            var lateCardUrls = [];
            $.each(cards, function(index, card) {
                var dueDt = null;
                if (card.due != null)
                    dueDt = new Date(card.due.substring(0,4), card.due.substring(5,7)-1, card.due.substring(8,10));
                
                if ( (hasLabel(card, Label.borrowRec) || hasLabel(card, Label.repairRec)) &&
                        card.idList != List.pending && card.idList != List.completed &&
                        (dueDt != null && dueDt < new Date())
                        ) {
                    console.log('late record: '+card.name);
                    if (card.checklists.length > 0) {
                        for (var i = 0; i < card.checklists[0].checkItems.length; i++) {
                            if (card.checklists[0].checkItems[i].state == 'incomplete') {
                                console.log('late item: '+card.checklists[0].checkItems[i].name);
                                lateCardUrls.push(card.checklists[0].checkItems[i].name);
                            }
                        }
                    }
                }
            });
            
            var autolinker = new Autolinker({
                replaceFn : function(autolinker, match) {
                    return cardUrlReplace(autolinker, match, cards);
                }
            });

            $.each(cards, function(index, card) {
                if (!hasLabel(card, Label.borrowRec) && !hasLabel(card, Label.repairRec)) {
                    var borrowed = isBorrowed(card);
                    var damaged = hasLabel(card, Label.damaged);
                    var broken = hasLabel(card, Label.broken);
                    var late = ($.inArray(card.url, lateCardUrls) > -1 ? true : false);
                    
                    var html = '<div class="list-card col-xs-12 col-sm-4 col-md-3">'+
                               '<a href="#">' +
                               '<div id="'+card.id+'" class="list-item">' +
                               card.name +
                               '<span class="glyphicon glyphicon-option-vertical pull-right" aria-hidden="true" style="color: #cccccc;"></span>' +
                               '<span class="pull-right">&nbsp;&nbsp;&nbsp;</span>';
                    // Borrowed
                    if (borrowed)
                        html += '<span class="pull-right" style="border-right: 5px #5cb85c solid;">&nbsp;</span>';

                    // have Damaged Label
                    if (damaged)
                        html += '<span class="pull-right" style="border-right: 5px #d9534f solid;">&nbsp;</span>';

                    // have Broken Label
                    if (broken)
                        html += '<span class="pull-right" style="border-right: 5px #666666 solid;">&nbsp;</span>';
                        
                    // Late
                    if (late)
                        html += '<span class="pull-right" style="border-right: 5px #666600 solid;">&nbsp;</span>';

                    html += '</div>' +
                            '</a>' +
                            '</div>';

                    if (hasLabel(card, Label.tent)) {
                        $('#tent-items').append(html);
                    } else if (hasLabel(card, Label.yurt)) {
                        $('#yurt-items').append(html);
                    } else if (hasLabel(card, Label.tentpeg)) {
                        $('#tentpeg-items').append(html);
                    } else if (hasLabel(card, Label.fly)) {
                        $('#fly-items').append(html);
                    } else if (hasLabel(card, Label.cookset)) {
                        $('#cookset-items').append(html);
                    } else if (hasLabel(card, Label.stove)) {
                        $('#stove-items').append(html);
                    } else {
                        $('#other-items').append(html);
                    }
                    
                    $('#'+card.id).on('click', function() {
                        // cover
                        var cover = '';
                        if (card.attachments.length > 0) {
                            console.log('att.url='+card.attachments[0].url);
                            cover = //'<div class="card-modal-cover">'+
                                    '<img src="'+card.attachments[0].url+'" class="img-responsive center-block" style="max-height: 200px;" />';
                                    //'</div>';
                            $('#card-modal-cover').html(cover);
                            $('#card-modal-cover').removeClass('hidden');
                        } else {
                            $('#card-modal-cover').addClass('hidden');
                        }
                        
                        // Label
                        var label = '';
                        if (borrowed)
                            label += '<span class="label label-success">借出</span>&nbsp;&nbsp;&nbsp;';
                        if (damaged)
                            label += '<span class="label label-danger">損壞</span>&nbsp;&nbsp;&nbsp;';
                        if (broken)
                            label += '<span class="label label-default">不能使用</span>&nbsp;&nbsp;&nbsp;';
                        if (label != '')
                            label = '<p>' + label + '</p>';
                        
                        // Format Description
                        var desc = card.desc;
                        desc = desc.replace(/\n\n\n/g, '<br>'); // \n\n\n -> <br>
                        desc = desc.replace(/\n/g, '<br>'); // \n -> <br>
                        desc = autolinker.link(desc); // url -> <a href="url">url</a>
                        
                        $('#card-modal').modal('show');
                        $('#card-modal-title').html(card.name);
                        $('#card-modal-body').html(label+desc);
                    });
                }
            });
        }

        $(function(){
            loadCards();
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">HKG81 QM</a>
            </div>
            <ul class="nav navbar-nav">
                <li><a href="#">首頁</a></li>
                <li><a href="index.html">借用申請</a></li>
                <li class="active"><a href="list.html">物資清單</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">

        <div class="alert alert-dismissible hidden" role="alert" id="alert-box">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <span id="alert-msg"></span>
        </div>

        <div style="text-align:right; font-size: 10px; color: #666666;">
            <span style="border-right: 5px #5cb85c solid;">&nbsp;</span>&nbsp;&nbsp;借出
            &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="border-right: 5px #d9534f solid;">&nbsp;</span>&nbsp;&nbsp;損壞
            &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="border-right: 5px #666666 solid;">&nbsp;</span>&nbsp;&nbsp;不能使用
        </div>
        <div id="loader" style="text-align:center;">
            <img src="img/loading.gif"/>
        </div>
        <div class="hidden items">
            <div class="list-title">A字營</div>
            <div id="tent-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">蒙古包</div>
            <div id="yurt-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">營釘</div>
            <div id="tentpeg-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">天幕</div>
            <div id="fly-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">炊具</div>
            <div id="cookset-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">爐頭</div>
            <div id="stove-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">其他</div>
            <div id="other-items" class="row"></div>
        </div>

    </div>

    <div id="card-modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 id="card-modal-title" class="modal-title"></h4>
                </div>
                <div id="card-modal-cover" class="modal-body card-modal-cover hidden">
                </div>
                <div id="card-modal-body" class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
</body>
</html>
