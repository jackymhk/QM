<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HKG81 QM Dashboard</title>
    <link rel="stylesheet" media="screen" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker3.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>

    <script src="http://code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" type="text/javascript"></script>
    <!--<script src="https://api.trello.com/1/client.js?key=8a42b4468e08ca9f165c88d1327add61"></script>-->
    <script src="js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="js/Autolinker.min.js" type="text/javascript"></script>
    <script src="js/main.js" type="text/javascript"></script>

    <script type="text/javascript">
        var cards = [];
        var loadCards = function() {
            trelloGet('/boards/'+Board+'/cards?attachments=cover&checklists=all',
                showCards,
                function() { failAlert("load cards fail"); }
            );
        };

        var showCards = function(data) {
            $('#loader').remove();
            $('.items').removeClass('hidden');

            cards = data;
            cards.sort( function(a, b) {
                /*
                var a_seq = getItemLabelSeq(a);
                var b_seq = getItemLabelSeq(b);
                if (a_seq != b_seq) {
                    return (a_seq > b_seq ? 1 : -1);
                } else {
                */
                    return a.name.localeCompare(b.name);
                //}
            });

            // Find out late items
            var lateCardUrls = [];
            $.each(cards, function(index, card) {
                var dueDt = null;
                if (card.due != null)
                    dueDt = new Date(card.due.substring(0,4), card.due.substring(5,7)-1, card.due.substring(8,10));

                if ( (hasLabel(card, Label.borrowRec) || hasLabel(card, Label.repairRec)) &&
                        card.idList != List.pending && card.idList != List.completed &&
                        (dueDt != null && dueDt < new Date())
                        ) {
                    console.log('late record: '+card.name);
                    if (card.checklists.length > 0) {
                        for (var i = 0; i < card.checklists[0].checkItems.length; i++) {
                            if (card.checklists[0].checkItems[i].state == 'incomplete') {
                                console.log('late item: '+card.checklists[0].checkItems[i].name);
                                lateCardUrls.push(card.checklists[0].checkItems[i].name);
                            }
                        }
                    }
                }
            });

            var autolinker = new Autolinker({
                replaceFn : function(autolinker, match) {
                    return cardUrlReplace(autolinker, match, cards);
                }
            });

            $.each(cards, function(index, card) {
                if (!hasLabel(card, Label.borrowRec) && !hasLabel(card, Label.repairRec)) {
                    var borrowed = isBorrowed(card);
                    var late = ($.inArray(card.url, lateCardUrls) > -1);
                    var repair = (card.idList == List.repair);
                    var drying = (card.idList == List.drying);
                    var damaged = hasLabel(card, Label.damaged);
                    var broken = hasLabel(card, Label.broken);

                    var html = '<div class="list-card col-xs-12 col-sm-4 col-md-3">'+
                               '<a href="javascript: true;">' +
                               '<div id="'+card.id+'" class="list-item">' +
                               card.name;

                    if (broken)
                        html += '<span class="item-lbl item-lbl-broken pull-right">&nbsp;</span>';
                    if (damaged)
                        html += '<span class="item-lbl item-lbl-damaged pull-right">&nbsp;</span>';
                    if (drying)
                        html += '<span class="item-lbl item-lbl-drying pull-right">&nbsp;</span>';
                    if (repair)
                        html += '<span class="item-lbl item-lbl-repair pull-right">&nbsp;</span>';
                    if (late)
                        html += '<span class="item-lbl item-lbl-late pull-right">&nbsp;</span>';
                    if (borrowed)
                        html += '<span class="item-lbl item-lbl-borrowed pull-right">&nbsp;</span>';
                    if (!broken && !damaged && !drying && !repair && !late && !borrowed)
                        html += '<span class="glyphicon glyphicon-option-vertical pull-right" aria-hidden="true" style="color: #cccccc;"></span>';

                    html += '</div>' +
                            '</a>' +
                            '</div>';

                    if (hasLabel(card, Label.tent)) {
                        $('#tent-items').append(html);
                    } else if (hasLabel(card, Label.yurt)) {
                        $('#yurt-items').append(html);
                    } else if (hasLabel(card, Label.tentpeg)) {
                        $('#tentpeg-items').append(html);
                    } else if (hasLabel(card, Label.fly)) {
                        $('#fly-items').append(html);
                    } else if (hasLabel(card, Label.cookset)) {
                        $('#cookset-items').append(html);
                    } else if (hasLabel(card, Label.stove)) {
                        $('#stove-items').append(html);
                    } else {
                        $('#other-items').append(html);
                    }

                    $('#'+card.id).on('click', function() {
                        //$('body').css('overflow','hidden');
                        //$('body').css('position','fixed');
                        // cover
                        var cover = '';
                        if (card.attachments.length > 0) {
                            console.log('att.url='+card.attachments[0].url);
                            cover = //'<div class="card-modal-cover">'+
                                    '<img src="'+card.attachments[0].url+'" class="img-responsive center-block" style="max-height: 200px;" />';
                                    //'</div>';
                            $('#card-modal-cover').html(cover);
                            $('#card-modal-cover').removeClass('hidden');
                        } else {
                            $('#card-modal-cover').addClass('hidden');
                        }

                        // Label
                        var label = '';
                        if (borrowed)
                            label += '<span class="label item-lbl-label item-lbl-borrowed">借出</span>';
                        if (late)
                            label += '<span class="label item-lbl-label item-lbl-late">逾時未還</span>';
                        if (repair)
                            label += '<span class="label item-lbl-label item-lbl-repair">維修中</span>';
                        if (drying)
                            label += '<span class="label item-lbl-label item-lbl-drying">晾曬中</span>';
                        if (damaged)
                            label += '<span class="label item-lbl-label item-lbl-damaged">損壞</span>';
                        if (broken)
                            label += '<span class="label item-lbl-label item-lbl-broken">不能使用</span>';
                        if (label != '')
                            label = '<p>' + label + '</p>';

                        // Format Description
                        var desc = card.desc;
                        desc = desc.replace(/\n\n\n/g, '<br>'); // \n\n\n -> <br>
                        desc = desc.replace(/\n/g, '<br>'); // \n -> <br>
                        desc = autolinker.link(desc); // url -> <a href="url">url</a>

                        $('#card-modal').modal('show');
                        $('#card-modal-title').html(card.name);
                        $('#card-modal-body').html(label+desc);
                    });
                }
            });
        }

        $(function(){
            loadCards();


        });
    </script>
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">HKG81 QM</a>
            </div>
            <ul class="nav navbar-nav">
                <li><a href="#">首頁</a></li>
                <li><a href="index.html">借用申請</a></li>
                <li class="active"><a href="list.html">物資清單</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">

        <div class="alert alert-dismissible hidden" role="alert" id="alert-box">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <span id="alert-msg"></span>
        </div>

        <!--<div class="row" style="margin-bottom: 20px;">
            <div class="item-lbl-key-container col-xs-12 col-sm-9 col-sm-push-3">
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-borrowed">&nbsp;</span>借出</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-late">&nbsp;</span>逾時未還</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-repair">&nbsp;</span>維修中</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-drying">&nbsp;</span>晾曬中</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-damaged">&nbsp;</span>損壞</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-broken">&nbsp;</span>不能使用</span>
            </div>
            <div class="col-xs-12 col-sm-3 col-sm-pull-9">
                <button type="button" class="btn btn-sm btn-link">
                    <span class="glyphicon glyphicon-filter" aria-hidden="true"></span> 篩選
                </button>
            </div>
        </div>-->

        <div class="row" style="margin-bottom: 20px;">
            <div class="item-lbl-key-container col-xs-9">
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-borrowed">&nbsp;</span>借出</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-late">&nbsp;</span>逾時未還</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-repair">&nbsp;</span>維修中</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-drying">&nbsp;</span>晾曬中</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-damaged">&nbsp;</span>損壞</span>
                <span class="item-lbl-key text-nowrap"><span class="item-lbl item-lbl-broken">&nbsp;</span>不能使用</span>
            </div>
            <div class="col-xs-3" style="text-align: right;">
                <button type="button" class="btn btn-sm btn-link">
                    <span class="glyphicon glyphicon-filter" aria-hidden="true"></span> 篩選
                </button>
            </div>
        </div>

        <div id="loader" style="text-align:center;">
            <img src="img/loading.gif"/>
        </div>
        <div class="hidden items">
            <div class="list-title">A字營</div>
            <div id="tent-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">蒙古包</div>
            <div id="yurt-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">營釘</div>
            <div id="tentpeg-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">天幕</div>
            <div id="fly-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">炊具</div>
            <div id="cookset-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">爐頭</div>
            <div id="stove-items" class="row"></div>
        </div>
        <div class="hidden items">
            <div class="list-title">其他</div>
            <div id="other-items" class="row"></div>
        </div>
        <div style="height: 100px">
            &nbsp;
        </div>
    </div>

    <div id="card-modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 id="card-modal-title" class="modal-title"></h4>
                </div>
                <div id="card-modal-cover" class="modal-body card-modal-cover hidden">
                </div>
                <div id="card-modal-body" class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->


</body>
</html>
