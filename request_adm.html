<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HKG81 QM Dashboard</title>
    <link rel="stylesheet" media="screen" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" >
    <link rel="stylesheet" type="text/css" href="css/main.css"/>

    <script src="https://code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://api.trello.com/1/client.js?key=8a42b4468e08ca9f165c88d1327add61" type="text/javascript"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js" type="text/javascript"></script>
    <script src="js/Autolinker.min.js" type="text/javascript"></script>
    <script src="js/main.js" type="text/javascript"></script>
    <script src="js/properties.js" type="text/javascript"></script>

    <script type="text/javascript">
        var requestShortLink;
        var cards = [];
        var lists = [];
        var request;
        var request_items = [];
        var request_stage = 1;

        var loadLists = function() {
            trelloGet('/boards/'+Board+'/lists',
            	function(data) { 
            	   lists = data;
            	   loadCards(); 
            	},
                function() { failAlert("load request fail"); }
            );
        };
        
        var loadCards = function() {
            trelloGet('/boards/'+Board+'/cards?checklists=all&actions=updateCheckItemStateOnCard',
                showRequest,
                function() { failAlert("load request fail"); }
            );
        };

        var showRequest = function(data) {
            $('#loader').remove();
            $('#requests').removeClass('hidden');

            cards = data;
            
            // Find out late items
            var lateCardUrls = getLateItems(cards);
            
            // Autolinker: utility to change url text to link
            var autolinker = new Autolinker({
                replaceFn : function(autolinker, match) {
                    // Custom function to get Trello card's name from card url
                    return cardUrlToName(autolinker, match, cards);
                }
            });

            // Autolinker: utility to change url text to link
            var urlRemover = new Autolinker({
                replaceFn : function(autolinker, match) {
                    // Custom function to remove card url
                    return cardUrlRemove(autolinker, match, cards);
                }
            });
            
            //---------------------------------------
            

            //---------------------------------------
            // Find request
            $.each(cards, function(index, card) {
                if (card.shortLink == requestShortLink)
                    request = card;
            });

            //---------------------------------------
            // Get request info
            request.custom = {}; // To store custom varables
            
            var dueDt = null;
            if (request.due != null)
                dueDt = new Date(request.due);
            
            // Check request status
            var pending = (request.idList == List.pending);
            var completed = (request.idList == List.completed);
            var overdue = (dueDt != null && dueDt < new Date() && request.badges.checkItemsChecked < request.badges.checkItems);
            var active = (hasLabel(request, Label.active) && !overdue);
            var borrowProcess = hasLabel(request, Label.borrowProcess);
            
            if (overdue)
            	$('#request').addClass('overdue');
            
            // Request stage
            if (pending)
            	request_stage = 1;
            else if (borrowProcess)
            	request_stage = 2;
            else if (active || overdue)
            	request_stage = 3;
            else if (completed)
            	request_stage = 4;

            // Label
            var label = '';
            if (overdue)
                label += '<span class="label st-label-large bg-overdue">逾時未還</span>';
            if (pending)
                label += '<span class="label st-label-large bg-pending">待處理</span>';
            if (borrowProcess)
                label += '<span class="label st-label-large bg-pending">借用處理中</span>';
            if (active)
                label += '<span class="label st-label-large bg-active">進行中</span>';
            if (completed)
                label += '<span class="label st-label-large bg-completed">完成</span>';
            if (label != '')
                label = '<p>' + label + '</p>';

            // Format Description
            var desc = request.desc;
            desc = desc.replace(/\n\n\n/g, '<br>'); // \n\n\n -> <br>
            desc = desc.replace(/\n/g, '<br>'); // \n -> <br>
            desc = urlRemover.link(desc); // url -> ''
            desc = desc.replace(/(<br>)+/g, '<br>'); // <br><br><br> -> <br>
            desc = desc.replace(/-------<br>-------/g, '-------'); // <br><br><br> -> <br>
            
            $('#request-detail').append(desc);

            var borrowDt = getBorrowDate(request);
            var activity = getActivity(request);
            var applicant = getApplicant(request);
            
            request.custom.borrowDt = borrowDt;
            request.custom.activity = activity;
            request.custom.applicant = applicant;
            
            var html = label +
                   '<strong>' + activity + '</strong>' +
                   '<div class="request-subheader">' +
                   '<div class="request-subheader-grp"><span class="glyphicon glyphicon-time" aria-hidden="true"></span> ' + borrowDt + ' / ' + dateFormat_ymd(dueDt) + '</div>' +
                   '<div class="request-subheader-grp"><span class="glyphicon glyphicon-check" aria-hidden="true"></span> ' + request.badges.checkItemsChecked+'/'+request.badges.checkItems + '</div>';
            
            $('#request-header').append(html);
            
            //---------------------------------------
            // Items
            if (request.checklists.length > 0) {
                for (var i = 0; i < request.checklists[0].checkItems.length; i++) {
                    var item = getCardByUrl(cards, request.checklists[0].checkItems[i].name);
                    item.custom = {}; // To store custom varables
                    
                    var location = getListNameById(lists, item.idList);
                    item.custom.location = location;
                    
                    // Check item status
                    var borrowed = isBorrowed(item);
                    var late = ($.inArray(item.url, lateCardUrls) > -1);
                    var repair = (item.idList == List.repair);
                    var drying = (item.idList == List.drying);
                    var damaged = hasLabel(item, Label.damaged);
                    var broken = hasLabel(item, Label.broken);
                    
                    item.custom.borrowed = borrowed;
                    item.custom.late = late;
                    item.custom.repair = repair;
                    item.custom.drying = drying;
                    item.custom.damaged = damaged;
                    item.custom.broken = broken;
                    
                    // item status label
                    var itemLabel = '';
                    if (borrowed)
                        itemLabel += '<span class="label st-label-large bg-borrowed">借出</span>';
                    if (late)
                        itemLabel += '<span class="label st-label-large bg-late">逾時未還</span>';
                    if (repair)
                        itemLabel += '<span class="label st-label-large bg-repair">維修中</span>';
                    if (drying)
                        itemLabel += '<span class="label st-label-large bg-drying">晾曬中</span>';
                    if (damaged)
                        itemLabel += '<span class="label st-label-large bg-damaged">損壞</span>';
                    if (broken)
                        itemLabel += '<span class="label st-label-large bg-broken">不能使用</span>';
                    if (itemLabel != '')
                        itemLabel = '<p style="margin: 0 0 2px;">' + itemLabel + '</p>';
                        
                    var returnDt = '';
                    if (borrowed || late) {
                    	returnDt = getReturnDate(item.idList);
                    }
                    item.custom.returnDt = returnDt;
                    
                    var itemsDOM = '';
                    itemsDOM += '<div class="request-body" id="item-' + item.shortLink + '">';
                    itemsDOM += '<div class="pull-right">';
                    itemsDOM += '<button type="button" class="btn request-ctrl-btn request-ctrl-btn-change txt-normal"><span class="glyphicon glyphicon-retweet" title="更改"></span></button>';
                    itemsDOM += '<button type="button" class="btn request-ctrl-btn request-ctrl-btn-remove txt-normal"><span class="glyphicon glyphicon-remove" title="移除"></span></button>';
                    itemsDOM += '<button type="button" class="btn request-ctrl-btn request-ctrl-btn-borrow txt-borrowed" data-toggle="button" aria-pressed="false" autocomplete="off"><span class="glyphicon glyphicon-export" title="借出"></span></button>';
                    itemsDOM += '<button type="button" class="btn request-ctrl-btn request-ctrl-btn-return txt-returned" data-toggle="button" aria-pressed="false" autocomplete="off"><span class="glyphicon glyphicon-ok" title="歸還"></span></button>';
                    itemsDOM += '</div>';
                    itemsDOM += item.name;
                    itemsDOM += itemLabel;
                    itemsDOM += '<div class="request-subheader">';
                    itemsDOM += '<div class="request-subheader-grp"><span class="glyphicon glyphicon-map-marker" title="地點/活動" aria-hidden="true"></span> ' + location + '</div>';
                    if (borrowed || late) {
                    	itemsDOM += '<div class="request-subheader-grp"><span class="glyphicon glyphicon-time" title="歸還日期" aria-hidden="true"></span> ' + returnDt + '</div>';	
                    }
                    itemsDOM += '</div>';
                    itemsDOM += '</div>';
                    
                    $('#request-items').append(itemsDOM);
                    request_items.push(item);
                }
            }

            // Trigger Progress Bar
            $('#progress-step-'+request_stage+' .progress-bar-btn').triggerHandler('click');
            
            
            stageChange(request_stage);
        }
        
        var stageChange = function(stage) {
        	request_stage = stage;
        	
        	// Update control buttons
            if (request_stage == 1) {
            	$('.request-ctrl-btn-change').show();
                $('.request-ctrl-btn-remove').show();
                $('.request-ctrl-btn-borrow').show();
                $('.request-ctrl-btn-return').hide();
            	
            	$('.request-ctrl-btn-borrow').attr('disabled', true);
            	
            } else if (request_stage == 2) {
            	$('.request-ctrl-btn-change').show();
                $('.request-ctrl-btn-remove').show();
                $('.request-ctrl-btn-borrow').show();
                $('.request-ctrl-btn-return').hide();
            	
            	$.each(request_items, function(index, item){
            		if (item.custom.borrowed || item.custom.late)
                        $('#item-' + item.shortLink + ' .request-ctrl-btn-borrow').attr('disabled', true);
                    else
                        $('#item-' + item.shortLink + ' .request-ctrl-btn-borrow').attr('disabled', false);
            		
            		if (item.idList == request.idList) 
            			$('#item-' + item.shortLink + ' .request-ctrl-btn-borrow').addClass('active').attr('aria-pressed', true);
            	});
            	
            } else if (request_stage == 3) {
            	$('.request-ctrl-btn-change').hide();
            	$('.request-ctrl-btn-remove').hide();
            	$('.request-ctrl-btn-borrow').hide();
            	$('.request-ctrl-btn-return').show();
            	
            } else if (request_stage == 4) {
                $('.request-ctrl-btn-change').hide();
                $('.request-ctrl-btn-remove').hide();
                $('.request-ctrl-btn-borrow').hide();
                $('.request-ctrl-btn-return').show();
                
            }
        }
        
        var stageInitAction = function(stage) {
        	if (request_stage == 1) {
        	    // No action
                
            } else if (request_stage == 2) {
                // create new list for request
                // move request card to new list
                // add borrowProcess label to request card
            	stage2_I_newList();
                
            } else if (request_stage == 3) {
            	// remove borrowProcess label from request card
            	// add active label to request card
                
            } else if (request_stage == 4) {
                // remove active label from request card
                // move request card to completed list
            }
        }
        
        var stage2_I_newList = function() {
        	var newList = {
                name: request.custom.activity + ' (' + request.custom.applicant + ')',
                idBoard: Board,
                pos: 'bottom'
            };
            trelloPost('/lists',
                newList,
                stage2_II_moveRequest,
                function() { failAlert("<strong>錯誤: </strong>Add List Failed"); }
            );
        }
        
        var stage2_II_moveRequest = function(list) {
        	trelloPut('/cards/'+request.id+'/idList',
        		{ value: list.id },
        		stage2_III_addLabel,
                function() { failAlert("<strong>錯誤: </strong>Move Request Failed"); }
            );
        }
        
        var stage2_III_addLabel = function() {
            trelloPost('/cards/'+request.id+'/idLabels',
            	{ value: Label.borrowProcess },
            	stage2_finish,
                function() { failAlert("<strong>錯誤: </strong>Add Label Failed"); }
            );
        }
        
        var stage2_finish = function() {
        	
        }
        
        var getReturnDate = function(idList) {
        	for (var i = 0; i < cards.length; i++) {
                if (cards[i].idList == idList && 
                		(hasLabel(cards[i], Label.borrowRec) || hasLabel(cards[i], Label.repairRec))) {
                    return dateFormat_ymd(new Date(cards[i].due));
                }
            }
        	return '';
        }

        $(function(){
            requestShortLink = urlParam('i');

            if (requestShortLink !== null) {
                trelloAuthorize(loadLists);
            } else {
                $('#loader').remove();
                failAlert("<strong>錯誤: </strong>Param is not existed.");
            }
            
            // Progress Bar onClick action
            $('.progress-bar-btn').on('click', function() {
            	updateProgressBar($(this));
            	var stage = $(this).data('stepnum');
            	stageChange(stage); // Change UI
            	stageInitAction(stage); // perform trello actions
            });
            
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">HKG81 QM</a>
            </div>
            <ul class="nav navbar-nav">
                <li><a href="index.html">首頁</a></li>
                <li class="active"><a href="request.html">借用申請</a></li>
                <li><a href="list.html">物資清單</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">

        <div class="alert hidden" role="alert" id="alert-box">
            <span id="alert-msg"></span>
        </div>

        <div id="loader" style="text-align:center;">
            <img src="img/loading.gif"/>
        </div>
        <div id="requests" class="row hidden">
            <div class="col-xs-12 col-sm-6">
                <div id="request" class="request">
                    <div class="request-header" id="request-header">
                    </div>
                    <div class="request-body" id="request-detail">
                    </div>
                    <div class="request-footer">
                        <div class="row bs-wizard">
                            <div id="progress-step-1" class="col-xs-3 bs-wizard-step complete">
                                <div class="text-center bs-wizard-stepnum">待處理</div>
                                <a href="javascript: ;" class="progress-bar-btn bs-wizard-dot unclickable" data-stepnum="1" data-totalstep="4" data-barlength="0"><span class="glyphicon" aria-hidden="true"></span></a>
                            </div>
                            <div id="progress-step-2" class="col-xs-3 bs-wizard-step disabled">
                                <div class="text-center bs-wizard-stepnum">借出</div>
                                <a href="javascript: ;" class="progress-bar-btn bs-wizard-dot" data-stepnum="2" data-totalstep="4" data-barlength="33%"><span class="glyphicon" aria-hidden="true"></span></a>
                            </div>
                            <div id="progress-step-3" class="col-xs-3 bs-wizard-step disabled">
                                <div class="text-center bs-wizard-stepnum">進行中</div>
                                <a href="javascript: ;" class="progress-bar-btn bs-wizard-dot" data-stepnum="3" data-totalstep="4" data-barlength="66%" data-chkoverdue="Y"><span class="glyphicon" aria-hidden="true"></span></a>
                            </div>
                            <div id="progress-step-4" class="col-xs-3 bs-wizard-step disabled">
                                <div class="text-center bs-wizard-stepnum">完成</div>
                                <a href="javascript: ;" class="progress-bar-btn bs-wizard-dot" data-stepnum="4" data-totalstep="4" data-barlength="100%"><span class="glyphicon" aria-hidden="true"></span></a>
                            </div>
                            <div class="progress"><div class="progress-bar progress-bar-success"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 col-sm-6">
                <div class="request request-items" id="request-items">
                    <div class="request-header">
                        <strong>清單</strong>
                    </div>
                    <!-- 
                    <div class="request-body">
                        <button type="button" class="btn request-ctrl-btn pull-right txt-borrowed" data-toggle="button" aria-pressed="false" autocomplete="off"><span class='glyphicon glyphicon-export'></span></button>
                        <button type="button" class="btn request-ctrl-btn pull-right txt-normal"><span class='glyphicon glyphicon-remove'></span></button>
                        <button type="button" class="btn request-ctrl-btn pull-right txt-normal"><span class='glyphicon glyphicon-retweet'></span></button>
                        HKG81/TE/01
                        <div class="request-subheader">
                            <span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span> 借用中
                        </div>
                    </div>
                    <div class="request-body">
                        <button type="button" class="btn request-ctrl-btn pull-right txt-borrowed active" data-toggle="button" aria-pressed="true" autocomplete="off"><span class='glyphicon glyphicon-export'></span></button>
                        <button type="button" class="btn request-ctrl-btn pull-right txt-normal" disabled><span class='glyphicon glyphicon-remove'></span></button>
                        <button type="button" class="btn request-ctrl-btn pull-right txt-normal" disabled><span class='glyphicon glyphicon-retweet'></span></button>
                        HKG81/TE/02
                        <div class="request-subheader">
                            <span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span> 借用中
                        </div>
                    </div>
                    <div class="request-body">
                        <button type="button" class="btn request-ctrl-btn pull-right txt-borrowed" data-toggle="button" aria-pressed="false" autocomplete="off"><span class='glyphicon glyphicon-export'></span></button>
                        <button type="button" class="btn request-ctrl-btn pull-right txt-normal"><span class='glyphicon glyphicon-remove'></span></button>
                        <button type="button" class="btn request-ctrl-btn pull-right txt-normal"><span class='glyphicon glyphicon-retweet'></span></button>
                        HKG81/TE/03
                        <div class="request-subheader">
                            <span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span> 借用中
                        </div>
                    </div>
                     -->
                </div>
            </div>
        </div>
        <div style="height: 100px">&nbsp;</div>
    </div>

</body>
</html>
